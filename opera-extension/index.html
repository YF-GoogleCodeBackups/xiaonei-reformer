<!DOCTYPE HTML>
<html>
  <head>
    <title>xnr background</title>
	<script type="text/javascript">
		opera.extension.onmessage=function(event) {
			var request=JSON.parse(event.data);
			switch(request.action) {
				case "save":
					localStorage.setItem("xnr_options",request.data);
					break;
				case "load":
					var options=localStorage.getItem("xnr_options");
					if(!options) {
						options={};
					}
					event.source.postMessage(JSON.stringify({reqId:request.reqId,data:options})); 
					break;
				case "storage":
					if (request.data) {
						localStorage.setItem(request.pref, request.data);
					} else {
						var data = localStorage.getItem(request.pref);
						event.source.postMessage(JSON.stringify({reqId:request.reqId,data:data})); 
					}
					break;
				case "get":
					var httpReq= new XMLHttpRequest();
					httpReq.onload=function() {
						if (httpReq.readyState == 4) {
							event.source.postMessage(JSON.stringify({reqId:request.reqId,data:(httpReq.status==200?httpReq.responseText:null)}));
						}
					};
					httpReq.onerror=function(e) {
						event.source.postMessage(JSON.stringify({reqId:request.reqId,data:null}));
					};
					httpReq.open(request.method,request.url,true);
					httpReq.send();
					break;
				case "album":
					// FIXME:无法下载图片
					opera.extension.tabs.create({focused:true, url:"javascript:'"+request.data+"'"});
					break;
			}
		};
	</script>
  </head>
</html>
