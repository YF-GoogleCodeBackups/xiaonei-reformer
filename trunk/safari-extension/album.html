<!DOCTYPE html>
<html>
<head>
	<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
	<title>下载相册</title>
	<style>
		img {
			height:128px;
			width:128px;
			border:1px solid #000000;
			margin:1px;
		}
	</style>
	<script>
		var album;
		function $(id) {
			if (id[0]=='#') {
				return document.getElementById(id.substring(1));
			} else {
				return document.createElement(id);
			}
		}
		function showPhotos() {
			try {
				album=JSON.parse(decodeURIComponent(/#(.*)$/.exec(location.href)[1]));
				$("#source").textContent=album.ref;
				if(album.unknown.length>0) {
					$("#unknown").style.display="block";
					var ulist=$("#ulist");
					for(var i=0;i<album.unknown.length;i++) {
						if(album.type) {
							var o=$("span");
							span.textContent=album.unknown[i];
						} else {
							var o=$("a");
							o.href=o.textContent=album.unknown[i];
						}
						ulist.appendChild(o);
						ulist.appendChild($("br"));
					}
				}
				$(album.type?"#gallerytitle":"#linktitle").style.display="none";
				if(album.data.length>0) {
					var list=$("#list");
					$("#count").textContent=album.data.length;
					for(var i=0;i<album.data.length;i++) {
						var img=album.data[i];
						if (album.type) {
							var o=$("a");
							o.href=img.src;
							o.setAttribute("index", img.i);
							o.title=img.title;
							o.textContent=img.src;
							list.appendChild(o);
							list.appendChild($("br"));
						} else {
							var o=$("img");
							o.setAttribute("height", "128");
							o.setAttribute("width", "128");
							o.setAttribute("index", img.i);
							o.src=img.src;
							o.title=img.title;
							list.appendChild(o);
						}
					}
				}
				if(album.title) {
					document.title=album.title;
				}
				$('#loading').style.display="none";
				$('#loaded').style.display="block";
			} catch(err) {
				$('#loading').textContent="数据传输出错！";
			}
		};
		function switchLink() {
			var links=document.querySelectorAll("a[title]:not([title=''])");
			for(var i=0;i<links.length;i++) {
				if(links[i].textContent!=links[i].title) {
					links[i].textContent=links[i].title;
				} else {
					links[i].textContent=links[i].href;
				}
			}
		};
		function switchIndex(add) {
			var max=album.data.length;
			var links=document.querySelectorAll("*[index]");
			for(var i=0;i<links.length;i++) {
				if(add) {
					links[i].title=idx(parseInt(links[i].getAttribute("index")),max)+" "+links[i].title;
				} else {
					links[i].title=links[i].title.replace(/^[0-9]+ /,"");
				}
			}
		};
		function idx(n,max) {
			var i=0;
			for(;max>0;max=parseInt(max/10)) {
				i++;
			}
			n="00000"+n;
			return n.substring(n.length-i,n.length);
		}
	</script>
</head>
<body onload="showPhotos()">
<div id="loading">
请稍候
</div>
<div id="loaded" style="display:none">
	<p><a target="_blank" href="http://code.google.com/p/xiaonei-reformer/wiki/DownloadAlbum">下载指南</a></p>
	<p>来源：<span id="source"></span></p>
	<div id="unknown" style="display:none">
		<p>未能取得以下地址的图片：</p>
		<div id="ulist"></div>
	</div>
	<p>图片数量：<span id="count"></span></p>
	<div id="linktitle">
		<p>使用下载工具软件下载本页面全部链接即可得到下列图片</p>
		<p><input type="button" onclick="switchLink()" value="切换链接描述"/></p>
	</div>
	<div id="gallerytitle">
		<p>亲爱的Safari用户，请在下列图片上逐个点鼠标右键手动保存。如果您有什么好的方法可以实现一次性保存全部图片，欢迎来信赐教</p>
	</div>
	<p><input type="checkbox" onclick="switchIndex(this.checked)">在描述前添加图片序号</input></p>
	<div id="list">
	</div>
</div>
</body>
</html>
